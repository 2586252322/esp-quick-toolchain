#!/bin/bash

rel=${rel:-2.5.0}
subrel=${subrel:-1}
make="-j 2"
which nproc >& /dev/null && make="-j $(($(nproc) + 1))"
gitopt="--depth 1 --single-branch"
arduino=${arduino:-${PWD}/arduino}

gcc=${gcc:-4.8}
case $gcc in
	4.8|4.9) isl=0.12.2; xtensa_branch=call0-${gcc}.2;;
	5.2)     isl=0.12.2; xtensa_branch=xtensa-ctng-esp-5.2.0;;
	7.2)     isl=0.16.1; xtensa_branch=xtensa-ctng-7.2.0;;
	*)       echo unhandled gcc version; exit 1;;
esac

# if using LTO, in arduino's platform.txt -gcc-ar must be used instead of -ar
# -flto -Wl,-flto must be added in all {c, cpp, s}'s flags
lto=${lto:-false}

# Default to linux building if nothing else set
host=${host:-linux}
EXE=""
MKSPIFFSTGT="linux"
case "$host" in
	linux)	HOST="x86_64-linux-gnu";      AHOST="x86_64-pc-linux-gnu"; EXT=".x86_64";;
	win32)	HOST="i686-w64-mingw32";      AHOST="i686-mingw32";        EXT=".win32";    EXE=".exe"; MKSPIFFSTGT='windows';;
	win64)	HOST="x86_64-w64-mingw32";    AHOST="x86_64-mingw32";      EXT=".win64";    EXE=".exe"; MKSPIFFSTGT='windows';;
	osx)	HOST="x86_64-apple-darwin14"; AHOST="x86_64-apple-darwin"; EXT=".osx";      MKSPIFFSTGT='osx';;
	arm64)	HOST="aarch64-linux-gnu";     AHOST="aarch64-linux-gnu";   EXT=".arm64";;
	rpi)	HOST="arm-linux-gnueabihf";   AHOST="arm-linux-gnueabihf"; EXT=".rpi";;
	*)	echo "Specify host as linux, win32, win64, osx, arm64, or rpi"; exit 2;;
esac

cleangit ()
{(
	test -d "dl/$1" || { true; return; }
	echo "cleaning $1"
	cd dl/$1
	git reset --hard HEAD
	git clean -f -d >& /dev/null
)}

clean()
{
	rm -rf arena log.* ${unfinished} xtensa-lx106-elf
	cleangit binutils-gdb-xtensa
	cleangit gcc-xtensa
	cleangit newlib-xtensa
	cleangit lx106-hal
	cleangit mkspiffs
	cleangit esptool
}

distclean()
{
	clean
	rm -rf *.json *.tar.gz *.zip xtensa-lx106-elf.* venv arduino pkg
}

# Put an artifact in a target dir describing what was built
markrevinfo()
{(
	git rev-parse HEAD
	git remote -v
	uname -a
	git diff
)}

maketool()
{
	if [ ! -r arena/jobdone-${tool} ]; then
		echo "-------- ${tool}"
		( rm -rf arena/${tool};
		  cp -a dl/${tool} arena/${tool};
		  pushd arena/${tool};
		  TARGET_OS=${MKSPIFFSTGT} CC=${HOST}-gcc CXX=${HOST}-g++ STRIP=${HOST}-strip \
		      make clean ${tool}${EXE} BUILD_CONFIG_NAME="-arduino-esp8266" ${extra_opts};
		  markrevinfo >& build-rev-info
		  popd;
		  mkdir -p ${install}/${tool};
		  cp -a arena/${tool}/${tool}${EXE} arena/${tool}/build-rev-info ${install}/${tool}/.;
		  pushd arena/${tool} && name=${tool}-$(git rev-parse --short HEAD) && popd;
		  pushd ${install};
		  tarball=${HOST}-$name.${tarext};
		  ${tarcmd} ${taropts} ../${tarball} ${tool};
		  popd;
		  makejson;
		  touch arena/jobdone-${tool};
		) >& $log.${tool}.log
	fi
}

makejson()
{
	tarballsize=$(stat -c%s ${tarball})
	tarballsha256=$(sha256sum ${tarball} | cut -f1 -d" ")
	( echo '{' &&
	  echo ' "host": "'$AHOST'",' &&
	  echo ' "url": "https://github.com/earlephilhower/esp-quick-toolchain/releases/download/'${rel}-${subrel}'/'${tarball}'",' &&
	  echo ' "archiveFileName": "'${tarball}'",' &&
	  echo ' "checksum": "SHA-256:'${tarballsha256}'",' &&
	  echo ' "size": "'${tarballsize}'"' &&
	  echo '}') > ${tarball}.json
}

install()
{
	# Get a fresh copy of the Arduino tree
	rm -rf ${arduino}
	git clone https://github.com/earlephilhower/Arduino ${arduino}

	# Need to rebuild and make install on newlib to get proper headers.  Crufty, but we have an odd dir structure
	echo "-------- Building installable newlib"
	rm -rf arena/newlib-install
	mkdir -p arena/newlib-install
	(cd arena/newlib-install; ../../dl/newlib-xtensa/configure ${configurenewlibinstall}) &> $log.20.newlib.conf.log
	(cd arena/newlib-install; CROSS_CFLAGS="-DSIGNAL_PROVIDED -DABORT_PROVIDED -DMALLOC_PROVIDED" make ${make}) &> $log.21.newlib.make.log
	# Remove atexit() from newlib
	(cd arena/newlib-install; for i in _atexit.o lib_a-atexit.o; do ar d ./xtensa-lx106-elf/newlib/libc.a $i; done )
	(cd arena/newlib-install; make install) &> $log.22.newlib.install.log
	echo "-------- Building installable hal"
	rm -rf arena/hal-install
	mkdir -p arena/hal-install
	(cd arena/hal-install; ../../dl/lx106-hal/configure --prefix=${arduino}/tools/sdk/libc --libdir=${arduino}/tools/sdk/lib --host=xtensa-lx106-elf $(echo ${configure} | sed 's/--host=[a-zA-Z0-9_-]*//' | sed 's/--prefix=[a-zA-Z0-9_-\\]*//')) &> $log.23.hal.conf.log
	(cd arena/hal-install; make ${make}) &> $log.24.hal.make.log
	(cd arena/hal-install; make install) &> $log.25.hal.install.log
	echo "-------- Copying GCC libs"
	cp ${installnative}/lib/gcc/xtensa-lx106-elf/*/libgcc.a ${arduino}/tools/sdk/lib/.
	cp ${installnative}/xtensa-lx106-elf/lib/libstdc++.a ${arduino}/tools/sdk/lib/.
	cp ${installnative}/xtensa-lx106-elf/lib/libstdc++-nox.a ${arduino}/tools/sdk/lib/.
	echo "-------- Copying toolchain directory"
	rm -rf ${arduino}/tools/sdk/xtensa-lx106-elf
	cp -a ${installnative}/xtensa-lx106-elf ${arduino}/tools/sdk/xtensa-lx106-elf
	echo "-------- Updating package.json"
	git=$(git rev-parse --short HEAD)
	ver=${rel}-${subrel}-${git}
	pkgfile=${arduino}/package/package_esp8266com_index.template.json
	./patch_json.py --pkgfile "${pkgfile}" --tool xtensa-lx106-elf-gcc --ver "${ver}" --glob '*xtensa-lx106-elf*.json'
	./patch_json.py --pkgfile "${pkgfile}" --tool esptool --ver "${ver}" --glob '*esptool*json'
	./patch_json.py --pkgfile "${pkgfile}" --tool mkspiffs --ver "${ver}" --glob '*mkspiffs*json'
	echo "Install done"
}

set -e

unfinished="zzz-not-fully-built-yet-zzz"

installnative=$(pwd)/xtensa-lx106-elf.x86_64
install=$(pwd)/xtensa-lx106-elf${EXT}
mkdir -p ${install}
log=$(pwd)/log
touch ${unfinished}

gccbuild=$(gcc -dumpmachine)
configure="--prefix=${install}"
if [ "$HOST" != "" ]; then
	configure+=" --build=${gccbuild}"
	configure+=" --host=${HOST}"
fi
configure+=" --target=xtensa-lx106-elf"
configure+=" --disable-shared"
configure+=" --with-newlib --enable-threads=no --disable-__cxa_atexit"
configure+=" --disable-libgomp --disable-libmudflap --disable-nls --disable-multilib --enable-languages=c,c++"
configure+=" --disable-bootstrap"
configure+=" --enable-lto"
configure+=" --disable-libstdcxx-verbose"

configurenewlibcom=" --with-newlib --enable-multilib --disable-newlib-io-c99-formats --disable-newlib-supplied-syscalls"
configurenewlibcom+=" --enable-newlib-nano-formatted-io --enable-newlib-reent-small --enable-target-optspace"
configurenewlibcom+=" --disable-option-checking"
configurenewlibcom+=" --target=xtensa-lx106-elf"
configurenewlibcom+=" --disable-shared"


configurenewlibinstall="--prefix=${arduino}/tools/sdk/libc --with-target-subdir=xtensa-lx106-elf"
configurenewlibinstall+=${configurenewlibcom}

configurenewlib="--prefix=${install}"
configurenewlib+=${configurenewlibcom}


if [ "${EXE}" == "" ]; then
	tarext="tar.gz"
	tarcmd="tar"
	taropts="zcf"
else
	tarext="zip"
	tarcmd="zip"
	taropts="-rq"
fi

if $lto; then
	export   CFLAGS_FOR_TARGET='-mlongcalls -flto -Wl,-flto -Os -g'
	export CXXFLAGS_FOR_TARGET='-mlongcalls -flto -Wl,-flto -Os -g'
else
	export   CFLAGS_FOR_TARGET='-mlongcalls -Os -g'
	export CXXFLAGS_FOR_TARGET='-mlongcalls -Os -g'
fi

export CFLAGS="-I${install}/include -pipe"
export LDFLAGS="-L${install}/lib"
export PATH="${installnative}/bin:${PATH}"
export LD_LIBRARY_PATH="${installnative}/lib"


case "$1" in
	clean)    clean; exit 0;;
	distclean)    distclean; exit 0;;
	build)    :;;
	install)  install; exit 0;;
	*)        echo "need 'clean', 'distclean', 'build', or 'install'"; exit 1;;
esac

echo "-----------------------------------------------------------------------------"
echo "Building GCC-${gcc} for architecture ${host} and release ${rel}-${subrel}"

echo "-------- Checking for required tools"
MISS=0
for i in flex bison autogen makeinfo autoreconf make gcc g++; do
	which $i >& /dev/null || ( echo "Missing: $i" && MISS=1 )
done
if [ $MISS -ne 0 ]; then exit; fi

mkdir -p arena

if [ ! -r arena/downloaded ]; then

	mkdir -p dl
	(
		cd dl
		test -d binutils-gdb-xtensa || git clone ${gitopt} https://github.com/earlephilhower/binutils-gdb-xtensa.git
		test -d gcc-xtensa          || git clone https://github.com/earlephilhower/gcc-xtensa.git
		test -d newlib-xtensa       || git clone ${gitopt} https://github.com/earlephilhower/newlib-xtensa.git
		test -d lx106-hal           || git clone https://github.com/earlephilhower/lx106-hal.git
		test -d mkspiffs            || git clone https://github.com/earlephilhower/mkspiffs.git
		test -d esptool             || git clone https://github.com/earlephilhower/esptool-ck.git esptool
	)

	( cd dl/gcc-xtensa && git reset --hard && git checkout ${xtensa_branch} )
	( cd dl/mkspiffs && git checkout 0.2.0 && git reset --hard && patch -p1 < ../../patches/mkspiffs/0.2.0-makefile.patch && git submodule update )

	# download and put tools directly in gcc directory
	# let gcc's configure deal with them in place

	gnu=ftp://gcc.gnu.org/pub/gcc/infrastructure
	for url in \
		${gnu}/gmp-6.1.0.tar.bz2 \
		${gnu}/mpfr-3.1.4.tar.bz2 \
		${gnu}/mpc-1.0.3.tar.gz \
		${gnu}/isl-${isl}.tar.bz2 \
		${gnu}/cloog-0.18.1.tar.gz \
		http://www.mr511.de/software/libelf-0.8.13.tar.gz \
		; do
	
		archive=${url##*/}
		name=${archive%.t*}
		base=${name%-*}
		ext=${archive##*.}
	
		echo "-------- getting $name"
		(cd dl; test -r $archive || wget $url)
		case "$ext" in
			gz)  (cd dl/gcc-xtensa; tar xfz ../$archive);;
			bz2) (cd dl/gcc-xtensa; tar xfj ../$archive);;
			*) echo "can't unarchive $archive"; exit 1;;
		esac
		(cd dl/gcc-xtensa; rm -f $base; ln -s $name $base)
	done

	touch arena/downloaded
fi

if [ ! -r arena/patched ]; then
	echo "-------- patching and tweaking"

	for p in patches/gcc-*.patch patches/gcc${gcc}/gcc-*.patch; do
		test -r "$p" || continue
		(cd dl/gcc-xtensa; echo "---- $p:"; patch -s -p1 < ../../$p)
	done
	for p in patches/bin-*.patch; do
		test -r "$p" || continue
		(cd dl/binutils-gdb-xtensa; echo "---- $p:"; patch -s -p1 < ../../$p)
	done
	for p in patches/lib-*.patch; do
		test -r "$p" || continue
		(cd dl/newlib-xtensa; echo "---- $p: "; patch -s -p1 < ../../$p)
	done
	
	# dirty-force HAL definition to binutils and gcc
	for overwrite in \
		dl/gcc-xtensa/include/xtensa-config.h \
		dl/binutils-gdb-xtensa/include/xtensa-config.h \
		; do
		(
			cat \
				dl/lx106-hal/include/xtensa/config/core-isa.h \
				dl/lx106-hal/include/xtensa/config/system.h \
			;
			cat << EOF
#define XCHAL_HAVE_FP_DIV           0
#define XCHAL_HAVE_FP_RECIP         0
#define XCHAL_HAVE_FP_SQRT          0
#define XCHAL_HAVE_FP_RSQRT         0
EOF
		) > $overwrite
	done
	
	touch arena/patched
fi

# configure build install binutils
if [ ! -r arena/binutils/jobdone ]; then
	echo "-------- gdb+binutils"
	mkdir -p arena/binutils
	(cd arena/binutils; ../../dl/binutils-gdb-xtensa/configure ${configure}) &> $log.01.binutils.conf.log
	(cd arena/binutils; make ${make}) &> $log.02.binutils.make.log
	(cd arena/binutils; make install) &> $log.03.binutils.install.log
	# add/fix link cc->gcc
	(cd ${install}/bin; ln -sf xtensa-lx106-elf-gcc${EXE} xtensa-lx106-elf-cc${EXE})
	touch arena/binutils/jobdone
fi

if [ ! -r arena/gcc/jobdone-stage1 ]; then
	echo "-------- gcc-stage1"
	# configure gcc
	mkdir -p arena/gcc
	(cd arena/gcc; ../../dl/gcc-xtensa/configure ${configure} ${configuregcc}) &> $log.04.gcc.conf.log
	# stage 1 (build compiler)
	(cd arena/gcc; make ${make} all-gcc; make install-gcc) &> $log.05.gcc.stage1.log
	touch arena/gcc/jobdone-stage1
fi

if [ ! -r arena/gcc/jobdone-newlib ]; then
	echo "-------- newlib"
	# configure and build newlib
	mkdir -p arena/newlib
	(cd arena/newlib; ../../dl/newlib-xtensa/configure ${configurenewlib}) &> $log.06.newlib.conf.log
	(cd arena/newlib; CROSS_CFLAGS="-DSIGNAL_PROVIDED -DABORT_PROVIDED -DMALLOC_PROVIDED" make ${make}) &> $log.07.newlib.make.log
	(cd arena/newlib; make install) &> $log.08.newlib.install.log
	touch arena/gcc/jobdone-newlib
fi

if [ ! -r arena/gcc/jobdone-stage2 ]; then
	echo "-------- gcc-stage2"
	# stage 2 (build libstdc++)
	(cd arena/gcc; make ${make}) &> $log.09.gcc.stage2.log
	(cd arena/gcc; make install) &> $log.10.gcc.install.log
	touch arena/gcc/jobdone-stage2
fi

if [ ! -r arena/gcc/jobdone-nox ]; then
	echo "-------- gcc-stage3 - noexceptions"
	# We copy existing stdc, adjust the makefile, and build a single .a to save much time
	rm -rf arena/gcc/xtensa-lx106-elf/libstdc++-v3-nox
	cp -a arena/gcc/xtensa-lx106-elf/libstdc++-v3 arena/gcc/xtensa-lx106-elf/libstdc++-v3-nox
	(cd arena/gcc/xtensa-lx106-elf/libstdc++-v3-nox; make clean; find . -name Makefile -exec sed -i 's/mlongcalls/mlongcalls -fno-exceptions/' \{\} \; ; make ${make}; ) >& $log.10a.gcc.nox.log
	(cp arena/gcc/xtensa-lx106-elf/libstdc++-v3-nox/src/.libs/libstdc++.a xtensa-lx106-elf${EXT}/xtensa-lx106-elf/lib/libstdc++-nox.a) >& $log.10b.gcc.nox.log
	touch arena/gcc/jobdone-nox
fi

if [ ! -r arena/hal/jobdone ]; then
	echo "-------- HAL"
	mkdir -p arena/hal
	(cd dl/lx106-hal; autoreconf -i) &> $log.11.hal.boostrap.log
	(cd arena/hal; ../../dl/lx106-hal/configure --host=xtensa-lx106-elf $(echo ${configure} | sed 's/--host=[a-zA-Z0-9_-]*//')) &> $log.12.hal.conf.log
	(cd arena/hal; make ${make}) &> $log.14.hal.make.log
	(cd arena/hal; make install) &> $log.15.hal.install.log
	touch arena/hal/jobdone
fi

echo "-------- Stripping binaries"
(${HOST}-strip ${install}/bin/* ${install}/libexec/gcc/xtensa-lx106-elf/*/c* ${install}/libexec/gcc/xtensa-lx106-elf/*/lto1 || true) >& $log.16.strip.log

echo "-------- Applying post"
for sh in post/${gcc}*.sh; do
	[ -x "$sh" ] && $sh ${EXT}
done

echo "-------- Creating package tgz"
markrevinfo >& build-rev-info
tarball=$HOST.xtensa-lx106-elf-$(git rev-parse --short HEAD).${tarext}
(rm -rf pkg && mkdir pkg && markrevinfo > pkg/build-rev-info && cd pkg && cp -a ../xtensa-lx106-elf${EXT} xtensa-lx106-elf && mv build-rev-info xtensa-lx106-elf && ${tarcmd} ${taropts} ../${tarball} xtensa-lx106-elf/)
makejson

tool=mkspiffs CPPFLAGS="-DSPIFFS_USE_MAGIC_LENGTH=0 -DSPIFFS_ALIGNED_OBJECT_INDEX_TABLES=1" maketool

tool=esptool extra_opts='' maketool

echo "all done (${install})"
rm -f ${unfinished}
